user nginx;     # 프로세스 실행 권한 사용자
worker_processes auto; 
error_log /var/log/nginx/error.log;  # 에러 로그 파일 위치
pid /run/nginx.pid;     

# stream 모듈 로드 
load_module /usr/lib64/nginx/modules/ngx_stream_module.so;

events {
    worker_connections 1024;   # 동시 접속 가능한 최대 클라이언트 수
}

### TCP Reverse Proxy 설정 ###
stream {

    # Control Plane 로드밸런싱 및 수동 Health Check 설정
    upstream control {
        least_conn;  # 현재 연결 수가 적은 서버로 트래픽 전달(기본값: 라운드로빈)
        server {{ url.control_plane[0]}}:6443  max_fails=3 fail_timeout=30s;  # 30초 동안 3번 이상 응답 실패 시 30초 동안 비활성화
        server {{ url.control_plane[1]}}:6443  max_fails=3 fail_timeout=30s;
        server {{ url.control_plane[2]}}:6443  max_fails=3 fail_timeout=30s;
    }

    server {
        listen 6443;               # 6443번 포트 + TCP 통신
        proxy_pass control;        # 트래픽을 전달할 Control Plane 서버
    }
}

### HTTP/HTTPS Reverse Proxy 설정 ###
http {
    include /etc/nginx/mime.types; 
    default_type application/octet-stream;  

    # MinIO API 로드밸런싱 및 수동 Health Check 설정
    upstream minio {
        ip_hash;
        server {{ url.minio[0]}}:9000   max_fails=3 fail_timeout=30s;   # 30초 동안 3번 이상 응답 실패 시 30초 동안 비활성화
        server {{ url.minio[1]}}:9000   max_fails=3 fail_timeout=30s;
    }

    # MinIO 콘솔 로드밸런싱 및 수동 Health Check 설정
    upstream minio_console {
        ip_hash;
        server {{ url.minio[0]}}:9001   max_fails=3 fail_timeout=30s;   # 30초 동안 3번 이상 응답 실패 시 30초 동안 비활성화
        server {{ url.minio[1]}}:9001   max_fails=3 fail_timeout=30s;
    }
    
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                     '$status $body_bytes_sent "$http_referer" '
                     '"$http_user_agent" "$http_x_forwarded_for"'; 

    access_log /var/log/nginx/access.log main;  

    sendfile on;               # 파일 전송 최적화
    tcp_nopush on;             # TCP Nagle 알고리즘 비활성화
    tcp_nodelay on;            # 패킷 지연 방지
    keepalive_timeout 65;      # 연결 유지 시간
    types_hash_max_size 2048;  # MIME 타입 해시 크기

    # 캐시 경로 및 정책 설정
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=nginx_cache:100m inactive=30d max_size=10g;

    # HTTP 요청을 HTTPS로 강제 리디렉션
    server {
        listen 80;  
        server_name {{ domain }};
        return 301 https://$host$request_uri;   # 80 포트로 들어오면 443으로 리디렉트
    }  

    server {
        listen 443 ssl;   # 443 포트 + HTTPS 통신
        server_name {{ domain }};

        # SSL/TLS 설정
        ssl_certificate         /etc/ssl/certs/my_server.crt;
        ssl_certificate_key     /etc/ssl/private/my_server.key; 
        
        # Web Application
        location / {
            proxy_pass http://{{ url.web }}/;           # metalLB 서버 주소
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Image & Video Cache
        location ~* \.(?:css|js|gif|png|jpg|m3u8|ts)$ {
            proxy_pass http://{{ url.web }};
            proxy_cache nginx_cache;                # 캐시 영역 지정
            proxy_cache_valid 200 301 302 10d;      # 요청이 성공하면 응답을 10일 동안 캐싱
            proxy_cache_valid 404   1m;             # 에러 페이지는 짧게 1분 동안 캐싱
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;  # 원본 서버에 문제가 생길 경우, 오래된 캐시라도 응답
            proxy_cache_lock  on;                   # 동시 요청 시 하나만 원본 서버로 전달
            expires 10d;  # 사용자 브라우저에 10일 동안 캐싱
            
            add_header X-Cache-Status $upstream_cache_status;  # 캐시 상태 여부를 응답 헤더에 표시 

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Jenkins
        location /jenkins/ {
            proxy_pass http://{{ url.jenkins }}:8080/;  # Jenkins 서버 주소 
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # MinIO API
    server {
        server_name {{ domain }};

        client_max_body_size 0;  # 업로드 용량 제한 없음

        # 버퍼링 비활성화
        proxy_buffering off;
        proxy_request_buffering off;

        location / {
            proxy_pass http://minio;   # MinIO 서버 주소 
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # MinIO Consol
    server {
        listen 9001;   # 9001번 포트 + HTTP 통신
        server_name {{ domain }};

        location / {
            proxy_pass http://minio_console;   # MinIO 서버 주소 
            
         
            # 웹 소켓 지원
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Origin http://$host;

            add_header X-Server $upstream_addr;   # 실제 요청을 처리한 서버의 IP 주소와 포트 정보를 응답 헤더에 추가 
        }
    }
} 

